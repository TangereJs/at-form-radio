<link rel="import" href="../at-core-theme/at-core-theme.html">
<link rel="import" href="../at-form-behaviors/at-form-behaviors-validation.html">

<dom-module id="at-form-radio">
  <style media="screen">
    :host {
      --error-color: #e41e2b;
    }

    .hidden {
      display: none;
    }

    .label-container > label {
      font-weight: bold;
    }

    .label-container.error > label {
      color: var(--error-color);
    }

    .hint-container.error > p {
      color: var(--error-color);
    }
  </style>
  <template>
    <at-core-theme></at-core-theme>
    <div id="atFormRadioWrapper">
      <div id="labelContainer" class="label-container">
        <label id="label">{{label}}</label>
      </div>
      <div class="ui form">
        <div class="grouped fields" id="insertPoint"></div>
      </div>
      <div id="hintContainer" class="hint-container">
        <p id="errorHtml" class="hint"></p>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'at-form-radio',
      behaviors: [AtFormBehaviors.AtFormBehaviorsValidation],
      properties: {
        label: {
          type: String,
          value: 'at-form-radio'
        },
        hideLabel: {
          type: Boolean,
          value: false,
          observer: 'hideLabelChanged'
        },
        // ------------------------------------------------------------
        // valuelist renamed to xvaluelist is here to improve compatibility with copyProperties function in at-core-form/script/schema-helpers.js
        // this function goes through element properties and copies property values from property definition in json schema to element properties
        // now valuelist doens't exist in property definition in json schema so undefined will be copied
        // xvaluelist exists in json schema and when property name is valuelist, xvaluelist should be copied
        // so we introduce xvaluelist property in at-form-radio to remove if statement that would detect this situation
        // ------------------------------------------------------------
        xvaluelist: {
          type: Array,
          value: function() {
            return [];
          },
          observer: 'xvaluelistChanged',
          schema: {
            items: {
              type: "object",
              properties: {
                title: {
                  type: "string",
                  title: "Title"
                },
                value: {
                  type: "string",
                  title: "Value"
                }
              }
            }
          },
          layout: 'horizontal'
        },
        value: {
          type: String,
          value: '',
          observer: 'valueChanged'
        },
        required: {
          type: Boolean,
          value: false,
          observer: 'requiredChanged'
        },
        disabled: {
          type: Boolean,
          value: false,
          observer: 'disabledChanged'
        },
        /**
         * Hides the element. When hidden nothing is displayed for the element
         * @property hide
         * @type Boolean
         * @default false
         */
        hide: {
          type: Boolean,
          value: false,
          observer: 'hideChanged'
        }
      },
      $meta: [{
        title: "Radio",
        type: "string",
        xtype: "radio"
      }],
      _scopeCssViaAttr: true,
      ready: function() {
        this._attachEvents();
        var boundValidateIsValueInXValueList = this._validateIsValueInXValueList.bind(this);
        this._validationFunctions.push(boundValidateIsValueInXValueList);
        this._isReady = true;
      },
      _validateIsValueInXValueList: function() {
        var valueList = this.xvaluelist;
        var value = this.value;
        var result = false;

        if (valueList.length < 1) {
          return true;
        }

        valueList.forEach(function(item, index) {
          result = result || item.value === value;
        });

        if (!result) {
          this._errorMessage = 'Value ' + value + ' is invalid.';
        }

        return result;
      },
      hideChanged: function(newValue, oldValue) {
        var wrapper = this.$.atFormRadioWrapper;
        this.toggleClass('hidden', newValue, wrapper);
        if (this._isReady) {
          this.validate();
        }
      },
      hideLabelChanged: function(newValue, oldValue) {
        this.toggleClass("hidden", newValue, this.$.labelContainer);
      },
      xvaluelistChanged: function(newValue, oldValue) {
        var self = this;

        // clear previous html
        Polymer.dom(this.$.insertPoint).innerHTML = '';

        // newValue can be CSV or array; detection needed and normlization to array
        newValue = this._convertToArray(newValue);
        if (this._isString(this.xvaluelist)) {
          this.xvaluelist = newValue;
          return;
        }

        newValue.forEach(function(element, index, array) {
          var fieldHtml = self._constructRadioField(element);
          Polymer.dom(self.$.insertPoint).appendChild(fieldHtml);
        });

        if (newValue.length > 0) {
          if (this.value === '') {
            var input = Polymer.dom(self.$.insertPoint).querySelector('input');
            if (input !== undefined) {
              Polymer.dom(input).setAttribute('checked', 'checked');
            }
            this.value = newValue[0].value;
            this.valueChanged(newValue[0].value, undefined);
          } else {
            var inputValue = this.value;
            var selector = "input[value='" + inputValue + "']";
            var input = Polymer.dom(this.$.insertPoint).querySelector(selector);
            if (input) {
              Polymer.dom(input).setAttribute('checked', 'checked');
            }
          }
        }

        this._attachEvents();

        this.disabledChanged(this.disabled, this.disabled);
      },
      valueChanged: function(newValue, oldValue) {
        if (!this._isReady) {
          return;
        }
        if (this._isString(newValue)) {
          this._clearChecked();
          // new value is string; use it as value to find the input
          var selector = "input[value='" + newValue + "']";
          var input = Polymer.dom(this.$.insertPoint).querySelector(selector);
          if (input) {
            Polymer.dom(input).setAttribute('checked', 'checked');
          }
          this.fire('value-changed', {
            value: this.value
          });
        }

        if (this._isReady) {
          this.validate();
        }
      },
      disabledChanged: function(newValue, oldValue) {
        var
          inputs = Polymer.dom(this.$.insertPoint).querySelectorAll('input'),
          len = inputs ? inputs.length : 0,
          i, item;

        for (var i = 0; i < len; i++) {
          item = inputs[i];
          this.toggleAttribute('disabled', newValue, item);
        }

        if (this._isReady) {
          this.validate();
        }
      },
      requiredChanged: function(newValue, oldValue) {
        if (this._isReady) {
          this.validate();
        }
      },
      _updateUIValidState: function(isValid) {
        var errorHtml = this.$.hintContainer;
        this.toggleClass('error', !isValid, errorHtml);
        var labelContainer = this.$.labelContainer;
        this.toggleClass('error', !isValid, labelContainer);
        var insertPoint = this.$.insertPoint;
        this.toggleClass('error', !isValid, insertPoint);
      },
      _clearChecked: function() {
        var
          selectedInputs = Polymer.dom(this.root).querySelectorAll('input[checked]'),
          len = selectedInputs.length,
          index,
          selectedInput;

        for (index = 0; index < len; index += 1) {
          selectedInput = selectedInputs[index];
          selectedInput.removeAttribute('checked');
        }
      },
      _attachEvents: function() {
        var
          radioBoxes = Polymer.dom(this.root).querySelectorAll('.ui .checkbox'),
          len = radioBoxes.length,
          index,
          radioBox,
          self = this;

        for (index = 0; index < len; index += 1) {
          radioBox = radioBoxes[index];

          radioBox.addEventListener('click', function(event) {
            event.stopPropagation();
            if (!self.disabled) {
              self._clearChecked();
              var currentTarget = event.currentTarget;
              var input = currentTarget.querySelector('input');
              input.setAttribute('checked', 'checked');

              self.value = input.value;
              self.fire('value-changed', {
                value: self.value
              });

            }
          });
        }
      },
      /*
        function _constructRadioField creates this div
        <div class="field">
          <div class="ui radio checkbox">
            <input type="radio">
            <label>Once a day</label>
          </div>
        </div>
      */
      _constructRadioField: function(data) {
        var
          fieldDiv = document.createElement('div'),
          radioDiv = document.createElement('div'),
          inputEl = document.createElement('input'),
          labelEl = document.createElement('label');

        Polymer.dom(fieldDiv).classList.add('field');
        Polymer.dom(radioDiv).classList.add('ui');
        Polymer.dom(radioDiv).classList.add('radio');
        Polymer.dom(radioDiv).classList.add('checkbox');

        Polymer.dom(labelEl).innerHTML = data.title;
        Polymer.dom(inputEl).setAttribute('type', 'radio');
        Polymer.dom(inputEl).setAttribute('value', data.value);

        Polymer.dom(inputEl).setAttribute('data-title', data.title);

        Polymer.dom(radioDiv).appendChild(inputEl);
        Polymer.dom(radioDiv).appendChild(labelEl);
        Polymer.dom(fieldDiv).appendChild(radioDiv);

        return fieldDiv;
      },
      _convertToArray: function(object) {
        var result = [];

        if (this._isArray(object)) {
          // object is already array; return
          return object;
        }

        if (this._isString(object) && object.indexOf(',') !== -1) {
          // object is CSV string; split, convert and return
          var
            splitItems = object.split(','),
            len = splitItems.length,
            i, item;
          for (var i = 0; i < len; i++) {
            item = splitItems[i];
            item = item.trim();
            result.push({
              value: item,
              title: item
            });
          }
        } else if (this._isString(object)) {
          result.push({
            value: object,
            title: object
          });
        }

        return result;
      },
      _isArray: function(object) {
        return Object.prototype.toString.call(object) === '[object Array]';
      },
      _isString: function(object) {
        return Object.prototype.toString.call(object) === '[object String]';
      },
      _isObject: function(object) {
        return Object.prototype.toString.call(object) === '[object Object]';
      }
    });
  </script>

</dom-module>
